<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - SkillSwap</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="top-bar-btn">Copy</button>
            <button class="top-bar-btn">Publish</button>
        </div>
        <div class="top-bar-right">
            <div class="notification-bell">
                ðŸ””
                <span class="notification-badge">3</span>
            </div>
            <div class="user-avatar-dropdown">
                <div class="avatar-circle"></div>
                <span>â–¼</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ðŸŽ“</span>
                <span class="logo-text">SkillSwap</span>
            </div>
            <nav class="main-nav">
                <a href="/discover.html">Discover</a>
                <a href="/matches.html">Matches</a>
                <a href="/messages.html" class="active">Messages</a>
                <a href="/profile.html">Profile</a>
                <a href="/login.html" id="login-link" style="display: none;">Login</a>
                <a href="#" id="logout-link" style="display: none;">Logout</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main style="display: flex; height: calc(100vh - 140px); max-width: 1400px; margin: 0 auto;">
        <!-- Conversations List -->
        <aside style="width: 300px; background: white; border-right: 1px solid #e0e0e0; overflow-y: auto;">
            <div style="padding: 1.5rem; border-bottom: 1px solid #e0e0e0;">
                <h2>Conversations</h2>
            </div>
            <div id="conversations-list">
                <div class="loading">Loading conversations...</div>
            </div>
        </aside>

        <!-- Chat Area -->
        <section style="flex: 1; display: flex; flex-direction: column;">
            <div id="chat-header" style="padding: 1.5rem; border-bottom: 1px solid #e0e0e0; background: white;">
                <h2 id="chat-title">Select a conversation</h2>
            </div>
            
            <div id="messages-container" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: #f5f5f5;">
                <div style="text-align: center; color: #666; padding: 3rem;">
                    Select a conversation to start messaging
                </div>
            </div>

            <div id="message-input-container" style="display: none; padding: 1.5rem; background: white; border-top: 1px solid #e0e0e0;">
                <form id="message-form" style="display: flex; gap: 1rem;">
                    <input type="text" id="message-input" placeholder="Type a message..." style="flex: 1; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 1rem;">
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </section>
    </main>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        let currentUserId = getCurrentUserId();
        let currentMatchId = null;
        let messageInterval = null;

        // Get matchId from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const matchIdParam = urlParams.get('matchId');

        async function loadConversations() {
            try {
                const matchesResponse = await fetch('/api/matches');
                const matches = await matchesResponse.json();
                
                const usersResponse = await fetch('/api/users');
                const allUsers = await usersResponse.json();
                
                const container = document.getElementById('conversations-list');
                
                if (matches.length === 0) {
                    container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">No conversations yet</div>';
                    return;
                }
                
                container.innerHTML = matches.map(match => {
                    const otherUser = match.user1.userId === currentUserId ? match.user2 : match.user1;
                    const user = allUsers.find(u => u.userId === otherUser.userId);
                    
                    if (!user) return '';
                    
                    return `
                        <div class="conversation-item" onclick="loadConversation(${match.matchId}, ${user.userId})" 
                             style="padding: 1rem; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background 0.2s;"
                             onmouseover="this.style.background='#f5f5f5'" 
                             onmouseout="this.style.background='white'">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"></div>
                                <div style="flex: 1;">
                                    <strong>${user.firstName || ''} ${user.lastName || ''}</strong>
                                    <p style="color: #666; font-size: 0.875rem; margin-top: 0.25rem;">${user.university || ''}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // If matchId in URL, load that conversation
                if (matchIdParam) {
                    const match = matches.find(m => m.matchId === parseInt(matchIdParam));
                    if (match) {
                        const otherUser = match.user1.userId === currentUserId ? match.user2 : match.user1;
                        loadConversation(match.matchId, otherUser.userId);
                    }
                }
            } catch (error) {
                document.getElementById('conversations-list').innerHTML = 
                    '<div class="error">Error loading conversations: ' + error.message + '</div>';
            }
        }

        async function loadConversation(matchId, otherUserId) {
            currentMatchId = matchId;
            
            try {
                const usersResponse = await fetch('/api/users');
                const allUsers = await usersResponse.json();
                const otherUser = allUsers.find(u => u.userId === otherUserId);
                
                document.getElementById('chat-title').textContent = 
                    `${otherUser.firstName || ''} ${otherUser.lastName || ''}`;
                document.getElementById('message-input-container').style.display = 'block';
                
                await loadMessages();
                
                // Auto-refresh messages every 3 seconds
                if (messageInterval) clearInterval(messageInterval);
                messageInterval = setInterval(loadMessages, 3000);
            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function loadMessages() {
            if (!currentMatchId) return;
            
            try {
                const response = await fetch(`/api/messages/${currentMatchId}`);
                const messages = await response.json();
                
                const container = document.getElementById('messages-container');
                container.innerHTML = messages.map(msg => {
                    const isOwn = msg.sender.userId === currentUserId;
                    return `
                        <div style="display: flex; justify-content: ${isOwn ? 'flex-end' : 'flex-start'}; margin-bottom: 1rem;">
                            <div style="max-width: 70%; padding: 0.75rem 1rem; background: ${isOwn ? '#667eea' : 'white'}; color: ${isOwn ? 'white' : '#333'}; border-radius: 18px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                                <p style="margin: 0;">${msg.messageContent}</p>
                                <span style="font-size: 0.75rem; opacity: 0.7; margin-top: 0.25rem; display: block;">
                                    ${new Date(msg.sentAt).toLocaleTimeString()}
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageContent = document.getElementById('message-input').value.trim();
            if (!messageContent || !currentMatchId) return;
            
            try {
                const messageData = {
                    match: { matchId: currentMatchId },
                    sender: { userId: currentUserId },
                    messageContent: messageContent
                };
                
                const response = await fetch('/api/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(messageData)
                });
                
                if (response.ok) {
                    document.getElementById('message-input').value = '';
                    loadMessages();
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        });

        loadConversations();
    </script>
</body>
</html>

